<!DOCTYPE html>
<html lang="en" class="h-100">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <!-- SEO manifest -->
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#2D8EFD" />

    <title>Integrity SRI hasher</title>

    <!-- External JS -->
    <script src="vendor/jquery-3.7.1.min.js"></script>
    <script src="vendor/jquery-ui-1.14.1.min.js"></script>
    <script src="vendor/bootstrap-5.3.8.min.js"></script>

    <!-- Local JS -->
    <script src="index.js" defer></script>
    <script src="reg-service-worker.js" defer></script>

    <!-- External CSS -->
    <link rel="stylesheet" href="vendor/bootstrap-5.3.8.min.css">
    <link rel="stylesheet" href="vendor/bootstrap-icons-1.13.1/bootstrap-icons.min.css">

    <!-- Local CSS -->
    <link rel="stylesheet" href="sri-hasher.css">

    <!-- favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="icon" href="resources/icon-256.png" type="image/png" sizes="256x256">
    <link rel="apple-touch-icon" href="resources/icon-512.png" sizes="512x512">

    <script>
	    if(location.protocol !== 'https:'){
		    alert('âš ï¸ A secure connection (HTTPS) is recommended.');
	    }
    </script>

    <!-- JSONã¯compact/minifyã—ã¦ãã‚Œãªã„ã®ã§ã‚ã–ã¨1è¡Œã« -->
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"SoftwareApplication","name":"sri-hasher","applicationCategory":"Utility","operatingSystem":"Web","description":"CDNã‚µãƒ–ãƒªã‚½ãƒ¼ã‚¹å®Œå…¨æ€§ã®ãƒãƒƒã‚·ãƒ¥ã‚’ç”Ÿæˆã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚ä½¿ãˆã¾ã™ã€‚","url":"https://ennacx.github.io/sri-hasher/","image":"https://ennacx.github.io/sri-hasher/resources/ogp-banner.png","creator":{"@type":"Person","name":"ennacx"}}</script>
</head>

<body>
    <main id="content" class="container-fluid">
        <fieldset id="generate-field">
            <h1><a href="./">ğŸ›¡ï¸ Integrity SRI Hasher</a></h1>
            <h2>Generates CDN subresource integrity hashes. Works offline too.</h2>

            <div id="offline-notice" class="alert alert-warning text-center py-2 d-none" role="alert">
                ğŸ£ Currently working in offline mode (using cache) ğŸ£
            </div>

            <div class="mt-4">
                <ul id="selectMode" class="nav nav-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button type="button" id="mode-fetch-tab" class="nav-link" data-bs-toggle="tab" data-bs-target="#mode-fetch-tab-pane" role="tab" aria-controls="mode-fetch-tab-pane" aria-selected="true">CDN Resources</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button type="button" id="mode-upload-tab" class="nav-link" data-bs-toggle="tab" data-bs-target="#mode-upload-tab-pane" role="tab" aria-controls="mode-upload-tab-pane" aria-selected="true">File Upload</button>
                    </li>
                </ul>

                <div id="selectModeContent" class="tab-content">
                    <div id="mode-fetch-tab-pane" class="tab-pane fade">
                        <div class="form-group">
                            <label for="url">Enter the CDN-URL the resource you want to use:</label>
                            <input type="text" name="url" id="url" class="form-control" placeholder="https://cdn.example.com/index.min.js" autocomplete="off" />
                        </div>
                    </div>
                    <div id="mode-upload-tab-pane" class="tab-pane fade">
                        <div class="form-group">
                            <label for="upload-file">Upload the resource file you want to use:</label>
                            <input type="file" name="upload-file" id="upload-file" class="form-control" />
                        </div>
                    </div>

                    <div class="form-group mt-3">
                        <label for="sri-hash">SRI Hash</label>
                        <select name="sri-hash" id="sri-hash" class="form-select">
                            <option value="SHA-256">SHA-256</option>
                            <option value="SHA-384">SHA-384</option>
                            <option value="SHA-512">SHA-512</option>
                        </select>
                    </div>

                    <div class="mt-4">
                        <button type="button" name="generate-hash" id="generate-hash" class="btn btn-sm btn-primary w-100">Hash</button>
                    </div>

                    <div class="mt-4">
                        <p class="allow-ext">Support formats:&ensp;<span class="ext"></span></p>
                    </div>
                </div>
            </div>

            <div id="result-field" class="mt-4">
                <div id="result" class="card" style="display: none;">
                    <div class="card-header">Result</div>
                    <div class="card-body">
                        <div id="sri">
                            <pre class="result-mono"></pre>
                            <button type="button" name="copy-sri" id="copy-sri" class="w-100 btn btn-sm btn-outline-primary copy-btn"><i class="bi bi-copy me-2"></i>Copy SRI</button>
                        </div>
                        <div id="sri-tag" class="mt-4">
                            <pre class="result-mono"></pre>
                            <button type="button" name="copy-sri-tag" id="copy-sri-tag" class="w-100 btn btn-sm btn-outline-primary copy-btn"><i class="bi bi-copy me-2"></i>Copy SRI Tag</button>
                        </div>
                    </div>
                </div>

                <div id="error-alert" class="alert alert-danger" role="alert" style="display: none;"></div>
            </div>
        </fieldset>

        <fieldset id="readme-field"></fieldset>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="d-flex" translate="no">
        <div class="ms-auto">
            <ul class="list-group list-group-horizontal copy-links">
                <li>&copy;&nbsp;2026&nbsp;Ennacx</li>
                <li><a href="https://ennacx.github.io/pwdgen/" target="_blank"><i class="bi bi-key"></i>Password Generator</a></li>
                <li><a href="https://ennacx.github.io/keygen/" target="_blank"><i class="bi bi-fingerprint"></i>KeyPair Generator</a></li>
                <li><a href="https://github.com/ennacx/sri-hasher" target="_blank"><i class="bi bi-github"></i>GitHub</a></li>
            </ul>
        </div>
    </footer>

    <script defer>
	    function detectMissingFeatures() {
		    const missing = [];

		    if(!(globalThis.crypto && crypto.subtle && typeof crypto.subtle.digest === 'function')){
			    missing.push('Web Crypto API (crypto.subtle.digest)');
		    }
		    if(typeof fetch !== 'function'){
			    missing.push('fetch()');
		    }
		    if(typeof URL !== 'function'){
			    missing.push('URL');
		    }
		    if(typeof btoa !== 'function'){
			    missing.push('btoa()');
		    }
		    if(!globalThis.jQuery){
			    missing.push('jQuery (failed to load)');
		    }

		    return missing;
	    }

	    function makeUnsupportedMessage(missing) {
		    return [
			    `This tool cannot run in your browser.\n\n`,
			    `Missing:\n- ${missing.join('\n- ')}\n\n`,
			    `Please use a modern browser (Chrome/Edge/Firefox/Safari) and access via HTTPS.`
		    ].join('');
	    }

	    const missing = detectMissingFeatures();
	    if(missing.length > 0){
		    const msg = makeUnsupportedMessage(missing);

		    // Hashãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
		    document.getElementById('generate-hash').disabled = true;

		    alert(msg);
	    }

        /**
         * Parses the given HTML string and extracts the child nodes.
         *
         * @param {string} htmlText - The HTML string to be parsed into nodes.
         * @return {Array<Element>} An array of child nodes parsed from the input HTML string.
         */
        function parseReadmeNodes(htmlText) {
            // ã¾ãš<html>/<body> ãŒç„¡ãã¦ã‚‚ç¢ºå®Ÿã«DOMåŒ–ã§ãã‚‹<template>ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æ‰±ã†
            const tpl = document.createElement('template');
            tpl.innerHTML = htmlText.trim();

            let nodes = Array.from(tpl.content.children);

            // markedãŒå®Œå…¨HTMLã‚’åã„ãŸå ´åˆã¯templateã®ç›´ä¸‹ã¯`<html>`ã«ãªã‚ŠãŒã¡ã§ã€ãã®å ´åˆã¯ä¸­ã®`<body>`ã‚’å„ªå…ˆã—ã¦æŠ½å‡º
            if (nodes.length === 1 && nodes[0].tagName === 'HTML') {
                const htmlEl = nodes[0];
                const body = htmlEl.querySelector('body');
                nodes = body ? Array.from(body.children) : Array.from(htmlEl.children);
            }

            // ã¾ã‚Œã«`template.content`ãŒç©ºã£ã½ã«ãªã‚‹ã‚±ãƒ¼ã‚¹ã«å‚™ãˆã¦ã®DOMParserãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (è¶…ãƒ¬ã‚¢ã‚±ãƒ¼ã‚¹)
            if(nodes.length === 0){
                const doc = new DOMParser().parseFromString(htmlText, 'text/html');
                nodes = Array.from(doc.body?.children ?? []);
            }

            return nodes;
        }

        /**
         * Constructs a definition list (dl element) from an array of marked nodes, organizing them into
         * definition terms (dt elements) and definition descriptions (dd elements) based on their tags.
         *
         * @param {HTMLElement[]} nodes
         *  - An array of HTML elements to be processed. The nodes are filtered to exclude elements with the tag name 'H1',
         *    and those with the 'H2' tag are treated as definition terms.
         * @return {HTMLDListElement}
         *  - A constructed definition list (dl element) containing the processed nodes organized into dt and dd pairs.
         */
        function buildDlFromMarkedNodes(nodes) {
            // DLã‚’ä½œã£ã¦ãŠã
            const dl = document.createElement('dl');

            // Optional:
            nodes = nodes
                // READMEã‚¿ã‚¤ãƒˆãƒ«ã¯ãƒšãƒ¼ã‚¸å´ã«ã‚ã‚‹ã®ã§ <h1> ã‚’æ¨ã¦ã‚‹
                .filter((n) => (n.tagName !== 'H1'))
                .map((n) => {
					if(n.tagName === 'P' && n.children.length >= 1){
						// å¤–éƒ¨ãƒªãƒ³ã‚¯ç”¨ã®å±æ€§ä»˜ä¸
						n.children = Array.from(n.children).map((nn) => {
							if(nn.tagName === 'A'){
								nn.target = '_blank';
								nn.rel = 'nofollow';
                            }

							return nn;
                        });
                    }

					return n;
                })
            ;

            // DDã‚¿ã‚°ç”¨
            let currentDD = null;

            // ãƒãƒ¼ãƒ‰å†…ã®è¦ç´ ã‚’ãƒ«ãƒ¼ãƒ—ã—ã¦<dt>ã¨<dd>ã‚’åˆ†ã‘ã¦ã„ã
            for(const node of nodes){
                // readmeã®å„è¦‹å‡ºã—ã¯ è¦‹å‡ºã—2 ã¨ã—ã¦ã„ã‚‹ã®ã§<h2>ã«ãªã£ã¦ã„ã‚‹
                if(node.tagName === 'H2'){
                    const dt = document.createElement('dt');
                    dt.innerHTML = node.innerHTML;
                    dl.appendChild(dt);

                    currentDD = document.createElement('dd');
                    dl.appendChild(currentDD);

                    continue;
                }

                // è¦‹å‡ºã—2ã‚ˆã‚Šå‰ã«æœ¬æ–‡ãŒã‚ã‚‹å ´åˆã¯æœ€åˆã®<dd>ã¨ã—ã¦å—ã‘ã‚‹ (ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ•)
                if(!currentDD){
                    currentDD = document.createElement('dd');
                    dl.appendChild(currentDD);
                }

                // è¦‹å‡ºã—2ãŒæ¥ã‚‹ã¾ã§ã®ãƒãƒ¼ãƒ‰ã¯<dd>ã§å›²ã†
                currentDD.appendChild(node.cloneNode(true));
            }

            return dl;
        }

        /**
         * Fetches and displays the README documentation from a specified HTML file.
         * This function targets an element with an ID of 'readme-field' and updates its contents with the loaded README.
         * If the fetch or processing fails, an alert message will be displayed within the target element.
         *
         * @return {Promise<void>} A promise that resolves when the README content is fetched and rendered, or an alert message is shown in case of an error.
         */
        async function fetchReadme() {
            // åŸ‹ã‚è¾¼ã¿å¯¾è±¡
            const field = document.getElementById('readme-field');
            if(!field){
                return;
            }

            field.innerHTML = '';

            try {
                const res = await fetch('readme.html', { cache: 'no-store' });

                if(!res.ok){
                    throw new Error(`Failed to load readme.html: ${res.status}`);
                }

                const htmlText = await res.text();
                const nodes    = parseReadmeNodes(htmlText);
                const dl       = buildDlFromMarkedNodes(nodes);

                field.appendChild(dl);
            } catch(e){
                console.error(e);

                field.innerHTML = '<div class="alert alert-warning" role="alert">Failed to load documentation.</div>';
            }
        }

        // â†‘ã®é–¢æ•°ã‚’ä½¿ã£ã¦`readme.html`ã‚’åŸ‹ã‚è¾¼ã‚€
        document.addEventListener('DOMContentLoaded', fetchReadme);
    </script>
</body>
</html>